---
title: "Datos SUBE AMBA"
author: "Tomas"
date: "21/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Librerías

Aca simplemente cargamos las librerias que vamos a ir usando:

```{r librerias}
library(tidyverse)
library(jsonlite)
library(geojsonio)
library(lubridate)
library(sf)
library(janitor)
```

## Datos

Estamos probando con datos de SUBE de una semana de Junio del 2019
```{r datos, echo=FALSE}
GPS <- read_delim("/Documentos//Datos Para OD/GPS/2019-06-13.csv", 
    ";", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE)


```

### Limpieza
vamos a ponerle bien los nombres a las columnas, 
darle un formato geoespacial

```{r}
columnas<-read_delim("/Documentos/Datos Para OD/GPS/gps_header.csv", 
    ";", escape_double = FALSE, col_names = TRUE, 
    trim_ws = TRUE)

columnas<-clean_names(columnas)
a<-colnames(columnas)
colnames(GPS)<-a

GPS<- st_as_sf(GPS, coords = c("longitude", "latitude"), crs = 4326)
```

```{r Vias principales}
vias<- read_sf("/Google Drive/00 Trabajo/MOP/DPIT/shapes/Vial/Propuesta Primaria/PRIMARIA_TRAMOS_BUSES/PRIMARIA_TRAMOS_BUSES.shp")

st_crs(vias)

vias<-st_transform(vias,5348)
st_node(vias)

buffer<-filter(vias,red_RMBA=="primaria") %>% 
               st_buffer(25) %>% 
                st_transform(4326)

```
```{r}
gps_principales<-st_intersection(GPS,buffer)

gps_principales<-select(gps_principales, codigoentidad, idlinea, interno, c_ld_id, dtsn, date_time, type, direction, status, IDTRAMO)
gps_principales<-mutate(gps_principales, date_time==date(date_time))
```
```{r}
primeros<-function(A){
    select(A, date_time, interno,idlinea, IDTRAMO) %>% 
    mutate (date_time=dmy_hms(date_time)) %>%
    arrange( interno, date_time) %>% 
    group_by(idlinea, interno, IDTRAMO) %>% 
    mutate(agrupado=(date_time-lag(date_time))/dminutes(1)) %>% 
    mutate(agrupado = if_else(is.na(agrupado),1,if_else(agrupado>20,1,0))) %>% 
    filter(agrupado==1)
  
}
```
```{r}
gps_primeros<-primeros(gps_principales)
gps_primeros<- mutate(gps_primeros, hora=hour(date_time))
```




### exportacion

```{r}
write_sf(gps_primeros,"/Documentos/Datos Para OD/GPS/2019_06_13_primeros_2.geojson")

```

### Procesamiento

Vamos a intetar limpiar algunos registros.
Dentro de los puntos que estamos detectando tambien estamos agarrando puntos de las transversales, esto puede ser especialmente problemático en la interseccion con arterias importantes.

Vamos a hacer lo siguiente:
1 vamos a armar un registro para cada par tramo-linea
2 vamos a hacer un join entre los puntos y los tramos
3 filtramos aquellos que coincida linea con 
